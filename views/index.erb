<h1>Room # <a href="<%= "#{request.scheme}://#{request.host}:#{request.port}/room/#{@connection}" %>"><%= @connection%></a></h1>
<ul id="manuscript"></ul>

<input type="text" name="message" id="message" placeholder="Say something..." required="required" />


<div pub-key="pub-32d1b09f-63b7-4015-8e59-bd603a2ec66e" sub-key="sub-7e2e745c-c38c-11e0-a0a5-53ec83638759" ssl="off" origin="pubsub.pubnub.com" id="pubnub"></div>
<script src="http://cdn.pubnub.com/pubnub-3.1.min.js"></script>
<script>
	$(function(){
		var connection = "<%= @connection %>";
		var channel = "chatterbee-chatter-room-" + connection;
		var manuscript = $("#manuscript");
		var message = $("#message");
		
		PUBNUB.history({
		    channel : channel,
		    limit : 100

		// Set Callback Function when History Returns
		}, function(messages) 
		{
		    for(i in messages)
			{
				$("#manuscript").append("<li>" + messages[i] + "</li>");
			}

			scroll_to_bottom();
		});
	
		PUBNUB.subscribe({
		    channel  : channel,
		    callback : function(text) 
			{
				manuscript.append("<li>" + text + "</li>");
				scroll_to_bottom(manuscript);
			}
		});
		
		
		message.bind("keyup", function(e){
			var code = (e.keyCode ? e.keyCode : e.which);
			
			if(code == 13)
			{
				PUBNUB.publish({
			        channel : channel, 
					message : message.val()
			    });
			
				message.val("");
			}
		});
		
		
		window.onbeforeunload = function()
		{
			$.get("/leave/" + connection);
		}
		
		
		function scroll_to_bottom(elem)
		{
			elem.animate({ scrollTop: elem.prop("scrollHeight") }, 1000);
		}

	});
	
	
	
</script>